@Library('dfcc-ace-library@webhook') _

pipeline {
    agent any

    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'repo', value: '$.repository.clone_url'],
                [key: 'name', value: '$.repository.name'],
            ],
            token: 'abc123',
            tokenCredentialId: '',
            // printContributedVariables: true,
            // printPostContent: true,
            // silentResponse: false,
            // shouldNotFlatten: false,
            // regexpFilterText: '$ref',
        )
    }

    stages {
        
        stage('Clone Repo') {
            steps {
                echo "Cloning repository..."
                git credentialsId: 'github-token',
                    url: '$repo',
                    branch: 'CICD_TEST'
            }
        }
        
        stage('Build BAR') {
            steps {
                buildBar()
            }
        }
        
        stage('Override BAR') {
            steps {
                overrideBar('dev')
            }
        }

        // stage('Start ACE Integration Server') {
        //     steps {
        //         script {
        //             echo "Ensuring no old ACE server container or network is running..."

        //             sh 'docker rm -f ace-server || true' // '|| true' prevents pipeline failure if container doesn't exist

        //             sh 'docker network rm ace-network || true'

        //             echo "Creating a custom Docker network for ACE and ibmint containers..."

        //             sh 'docker network create ace-network'

        //             echo "Starting IBM App Connect Enterprise integration server container on custom network..."
                    
        //             sh 'docker run -d --name ace-server -p 7600:7600 --volumes-from jenkins -e LICENSE=accept --network ace-network ibmcom/ace:latest '
                    
        //             echo "Waiting for ACE server to start up (30 seconds)..."
        //             // IMPORTANT: This 'sleep' is a simple wait. For production, consider a more robust health check
        //             // (e.g., polling the ACE REST API or checking container logs for "ready" messages).
        //             sleep 30

        //             echo "ACE server should be up and running now."

        //             echo "Fetching ACE server logs for verification..."

        //             sh 'docker logs ace-server' 
        //         }
        //     }
        // }

        // stage('Deploy BAR') {
        //     steps {
        //         echo "Deploying BAR file to ACE integration server..."
                
        //         sh '''
        //             docker run --rm \\
        //               --volumes-from jenkins \\
        //               --network ace-network \\
        //               ibmint:latest deploy \\
        //               --input-bar-file /var/jenkins_home/workspace/generic-webhook-trigger-pipeline/$name.bar \\
        //               --output-host ace-server \\
        //               --output-port 7600
        //             echo "BAR file deployment initiated successfully."
        //         '''
        //     }
        // }
    }
}
