@Library('dfcc-ace-library@webhook') _

pipeline {
    agent any
    
    parameters {
        choice(
            name: 'TARGET_ENV',
            choices: ['dev', 'sitbr1', 'sitbr2', 'uatbr1', 'uatbr2'],
            description: 'Select the target environment to deploy to'
        )
    }

    // parameters {
    //         string(name: 'TARGET_ENV', defaultValue: 'dev', description: 'Target environment to deploy to (e.g., dev, qa, prod)')
    //     }
    
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'repo', value: '$.repository.clone_url'],
                [key: 'name', value: '$.repository.name'],
            ],
            token: 'abc123',
            tokenCredentialId: '',
            // printContributedVariables: true,
            // printPostContent: true,
            // silentResponse: false,
            // shouldNotFlatten: false,
            // regexpFilterText: '$ref',
        )
    }

    stages {
        
        stage('User Input - Select Environment') {
            steps {
                script {
                    // Pause pipeline and ask for environment selection
                    env.TARGET_ENV = input(
                        id: 'userInput', 
                        message: 'Select the target environment for deployment:',
                        parameters: [
                            choice(
                                name: 'TARGET_ENV',
                                choices: ['dev', 'sitbr1', 'sitbr2', 'uatbr1', 'uatbr2'],
                                description: 'Choose the environment to deploy to'
                            )
                        ]
                    )
                    echo "User selected environment: ${env.TARGET_ENV}"
                }
            }
        }
        
        stage('Clone Repo') {
            steps {
                echo "Cloning repository..."
                git credentialsId: 'github-token',
                    url: '$repo',
                    branch: 'CICD_TEST'
            }
        }
        
        stage('Build BAR') {
            steps {
                buildBar()
            }
        }
        stage('Override BAR') {
            steps {
                overrideBar(params.TARGET_ENV)
            }
        }
        stage('Deploy BAR') {
            steps {
                deployBar(params.TARGET_ENV)
            }
        }
    }
}
